#!/usr/bin/env python3

import sys
import csv
from ofxtools.Parser import OFXTree

def extract_fieldnames_and_values(ofx_file):
    # Parse the OFX file
    tree = OFXTree()
    tree.parse(ofx_file)

    # Convert the tree to an OFX object
    ofx = tree.convert()

    # Extract the field names and values
    fieldnames = []
    transactions = []

    # Extract the BANKMSGSRSV1 object
    bankmsgs = ofx.bankmsgsrsv1

    # Extract the STMTTRNRS object
    stmttrnrs = bankmsgs.stmttrnrs

    # Extract the STMTRS object
    stmtrs = stmttrnrs.stmtrs

    # Extract the BANKTRANLIST object
    banktranlist = stmtrs.banktranlist

    # Iterate over the transactions
    for transaction in banktranlist.stmttrn:
        fieldnames.extend(transaction.__dict__.keys())
        transactions.append(transaction.__dict__)

    # Remove duplicates from fieldnames
    fieldnames = list(set(fieldnames))

    return fieldnames, transactions

def write_to_csv(fieldnames, transactions, csv_file):
    with open(csv_file, 'w', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        for transaction in transactions:
            writer.writerow(transaction)

if __name__ == "__main__":
    ofx_file = sys.argv[1]
    csv_file = sys.argv[2]
    fieldnames, transactions = extract_fieldnames_and_values(ofx_file)
    write_to_csv(fieldnames, transactions, csv_file)
